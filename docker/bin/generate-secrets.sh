#!/usr/bin/env bash
# Generate application secrets if they don't already exist
# Usage: generate-secrets.sh [--check-only]
#
# Generates (if missing):
#   - JWT_SECRET
#   - TOKEN_ENCRYPTION_KEY
#   - LLM_PROXY_KEY
#
# Options:
#   --check-only  Only check if secrets exist, don't generate

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="${SCRIPT_DIR}/.."
ENV_FILE="${PROJECT_DIR}/.env"

CHECK_ONLY=false

log() {
  echo "[generate-secrets] $1"
}

# Generate random 32-character alphanumeric string
generate_random_string() {
  LC_ALL=C tr -dc 'A-Za-z0-9' </dev/urandom | head -c 32
}

# Check if a key has a non-empty value in .env
key_has_value() {
  local key="$1"
  grep -qE "^${key}=.+" "$ENV_FILE" 2>/dev/null
}

# Set a key in .env file
set_key() {
  local key="$1"
  local value="$2"
  local comment="${3:-}"

  if grep -q "^${key}=" "$ENV_FILE"; then
    # Update existing key
    if [[ -n "$comment" ]]; then
      sed -i.bak "s|^${key}=.*|${key}=${value} # ${comment}|" "$ENV_FILE"
    else
      sed -i.bak "s|^${key}=.*|${key}=${value}|" "$ENV_FILE"
    fi
    rm -f "${ENV_FILE}.bak"
  else
    # Add new key
    if [[ -n "$comment" ]]; then
      echo "${key}=${value} # ${comment}" >> "$ENV_FILE"
    else
      echo "${key}=${value}" >> "$ENV_FILE"
    fi
  fi
}

# Parse arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    --check-only)
      CHECK_ONLY=true
      ;;
    -h|--help)
      echo "Usage: $(basename "$0") [--check-only]"
      echo ""
      echo "Options:"
      echo "  --check-only  Only check if secrets exist, don't generate"
      exit 0
      ;;
    *)
      echo "Error: Unknown argument: $1"
      exit 1
      ;;
  esac
  shift
done

# Validate .env exists
if [[ ! -f "$ENV_FILE" ]]; then
  log "ERROR: .env file not found at $ENV_FILE"
  log "Run setup-env.sh first to create .env from .env.example"
  exit 1
fi

SECRETS_TO_GENERATE=(
  "JWT_SECRET"
  "TOKEN_ENCRYPTION_KEY"
  "LLM_PROXY_KEY"
)

missing_count=0
generated_count=0

for secret in "${SECRETS_TO_GENERATE[@]}"; do
  if ! key_has_value "$secret"; then
    missing_count=$((missing_count + 1))
    if [[ "$CHECK_ONLY" == "true" ]]; then
      log "MISSING: $secret"
    else
      log "Generating $secret..."
      random_value=$(generate_random_string)
      set_key "$secret" "$random_value" "Auto-generated by Greptile"
      generated_count=$((generated_count + 1))
    fi
  else
    log "OK: $secret already set"
  fi
done

if [[ "$CHECK_ONLY" == "true" ]]; then
  if [[ $missing_count -gt 0 ]]; then
    log "$missing_count secret(s) missing"
    exit 1
  else
    log "All secrets present"
  fi
else
  if [[ $generated_count -gt 0 ]]; then
    log "Generated $generated_count secret(s)"
  else
    log "All secrets already present"
  fi
fi
