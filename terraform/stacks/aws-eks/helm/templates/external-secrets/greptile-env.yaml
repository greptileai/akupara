{{/*
Purpose:
- Primary ExternalSecret for Greptile services.
- Reads config/secrets from SSM Parameter Store and outputs `greptile-env` with env-var keys.
- Uses ExternalSecrets templating to derive connection URLs (DATABASE_URL, VECTOR_DB_URL, etc).
*/}}

apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: greptile-env
  namespace: {{ .Release.Namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: greptile-ssm
    kind: SecretStore
  target:
    name: greptile-env
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        NODE_ENV: {{ ternary "production" .Values.global.environment (eq .Values.global.environment "sandbox") | quote }}
        HATCHET_CLIENT_TLS_STRATEGY: "none"
        HATCHET_CLIENT_API_URL: {{ printf "http://%s-api:8080" .Release.Name | quote }}
        HATCHET_CLIENT_HOST_PORT: {{ printf "%s-engine:7070" .Release.Name | quote }}
        SERVER_AUTH_COOKIE_SECRETS: '{{ `{{ .SERVER_AUTH_COOKIE_SECRETS }}` }}'
        DB_HOST: '{{ `{{ .DB_HOST }}` }}'
        DB_PORT: '{{ `{{ .DB_PORT }}` }}'
        DB_USER: '{{ `{{ .DB_USER }}` }}'
        DB_NAME: '{{ `{{ .DB_NAME }}` }}'
        DB_PASSWORD: '{{ `{{ .DB_PASSWORD }}` }}'
        JWT_SECRET: '{{ `{{ .JWT_SECRET }}` }}'
        TOKEN_ENCRYPTION_KEY: '{{ `{{ .TOKEN_ENCRYPTION_KEY }}` }}'
        AWS_REGION: '{{ `{{ .AWS_REGION }}` }}'
        GREPTILE_API_URL: '{{ `{{ .GREPTILE_API_URL }}` }}'
        GREPTILE_AUTH_SERVER: {{ printf "http://auth:%d" (int .Values.auth.service.port) | quote }}
        APP_URL: '{{ `{{ .APP_URL }}` }}'
        GREPTILE_WEB_URL: '{{ `{{ .APP_URL }}` }}'
        URL: '{{ `{{ .APP_URL }}` }}'
        GREPTILE_WEBHOOK_URL: '{{ `{{ printf "%s/webhook" .GREPTILE_API_URL }}` }}'
        GITHUB_WEBHOOK_URL: '{{ `{{ printf "%s/webhook" .GREPTILE_API_URL }}` }}'
        GITLAB_WEBHOOK_URL: '{{ `{{ printf "%s/webhook" .GREPTILE_API_URL }}` }}'
        WEBHOOK_SECRET: '{{ `{{ .WEBHOOK_SECRET }}` }}'
        ANALYTICS: '{{ `{{ .ANALYTICS }}` }}'
        NOTIFICATIONS: '{{ `{{ .NOTIFICATIONS }}` }}'
        BILLING: "false"
        BILLING_ENABLED: "false"
        NEXT_PUBLIC_BILLING: "false"
        LINEAR_ENABLED: '{{ `{{ .LINEAR_ENABLED }}` }}'
        GITHUB_ENABLED: '{{ `{{ .GITHUB_ENABLED }}` }}'
        GITHUB_ENTERPRISE_ENABLED: '{{ `{{ .GITHUB_ENTERPRISE_ENABLED }}` }}'
        GITHUB_APP_ID: '{{ `{{ .GITHUB_APP_ID }}` }}'
        GITHUB_APP_URL: '{{ `{{ .GITHUB_APP_URL }}` }}'
        GITHUB_CLIENT_ID: '{{ `{{ .GITHUB_CLIENT_ID }}` }}'
        GITHUB_CLIENT_SECRET: '{{ `{{ .GITHUB_CLIENT_SECRET }}` }}'
        GITHUB_BOT_USERNAME: '{{ `{{ .GITHUB_BOT_USERNAME }}` }}'
        GITHUB_BOT_LOGIN: '{{ `{{ .GITHUB_BOT_LOGIN }}` }}'
        GITHUB_ENTERPRISE_APP_URL: '{{ `{{ .GITHUB_ENTERPRISE_APP_URL }}` }}'
        GITHUB_ENTERPRISE_APP_ID: '{{ `{{ .GITHUB_ENTERPRISE_APP_ID }}` }}'
        GITHUB_ENTERPRISE_API_URL: '{{ `{{ .GITHUB_ENTERPRISE_API_URL }}` }}'
        GITHUB_ENTERPRISE_URL: '{{ `{{ .GITHUB_ENTERPRISE_URL }}` }}'
        GITHUB_ENTERPRISE_CLIENT_ID: '{{ `{{ .GITHUB_ENTERPRISE_CLIENT_ID }}` }}'
        GITHUB_ENTERPRISE_CLIENT_SECRET: '{{ `{{ .GITHUB_ENTERPRISE_CLIENT_SECRET }}` }}'
        AUTH_GITHUB_ID: '{{ `{{ .AUTH_GITHUB_ID }}` }}'
        AUTH_GITHUB_SECRET: '{{ `{{ .AUTH_GITHUB_SECRET }}` }}'
        GITLAB_ENABLED: '{{ `{{ .GITLAB_ENABLED }}` }}'
        SLACK_ENABLED: '{{ `{{ .SLACK_ENABLED }}` }}'
        SLACK_WEBHOOK_URL: '{{ `{{ .SLACK_WEBHOOK_URL }}` }}'
        SLACK_CLIENT_ID: '{{ `{{ .SLACK_CLIENT_ID }}` }}'
        SLACK_CLIENT_SECRET: '{{ `{{ .SLACK_CLIENT_SECRET }}` }}'
        SLACK_SIGNING_SECRET: '{{ `{{ .SLACK_SIGNING_SECRET }}` }}'
        EMAIL_FROM: {{ .Values.greptile.emailFrom | quote }}
        AUTH_EMAIL_FROM: {{ .Values.greptile.emailFrom | quote }}
        {{- if .Values.llmproxy.enabled }}
        LLM_PROXY_BASE_URL: {{ printf "http://llmproxy:%d" (int .Values.llmproxy.service.port) | quote }}
        LLM_PROXY_KEY: '{{ `{{ .LLM_PROXY_KEY }}` }}'
        {{- end }}
        DATABASE_URL: 'postgresql://{{ `{{ .DB_USER }}` }}:{{ `{{ urlquery .DB_PASSWORD }}` }}@{{ `{{ .DB_HOST }}` }}:{{ `{{ .DB_PORT }}` }}/{{ `{{ .DB_NAME }}` }}'
        DIRECT_URL: 'postgresql://{{ `{{ .DB_USER }}` }}:{{ `{{ urlquery .DB_PASSWORD }}` }}@{{ `{{ .DB_HOST }}` }}:{{ `{{ .DB_PORT }}` }}/{{ `{{ .DB_NAME }}` }}'
        VECTOR_DB_HOST: '{{ `{{ .DB_HOST }}` }}'
        VECTOR_DB_PORT: '{{ `{{ .DB_PORT }}` }}'
        VECTOR_DB_USER: '{{ `{{ .DB_USER }}` }}'
        VECTOR_DB_PASSWORD: '{{ `{{ .DB_PASSWORD }}` }}'
        VECTOR_DB_NAME: "vector"
        VECTOR_DB_PROVIDER: "pgvector"
        VECTOR_EMBEDDINGS_TABLE_NAME: "embeddings"
        VECTOR_DB_URL: 'postgresql://{{ `{{ .DB_USER }}` }}:{{ `{{ urlquery .DB_PASSWORD }}` }}@{{ `{{ .DB_HOST }}` }}:{{ `{{ .DB_PORT }}` }}/vector'
        HATCHET_DATABASE_URL: 'postgresql://{{ `{{ .DB_USER }}` }}:{{ `{{ urlquery .DB_PASSWORD }}` }}@{{ `{{ .DB_HOST }}` }}:{{ `{{ .DB_PORT }}` }}/hatchet'
  data:
    - secretKey: DB_HOST
      remoteRef:
        key: {{ printf "%s/config/database-host" .Values.ssm.prefix | quote }}
    - secretKey: DB_PORT
      remoteRef:
        key: {{ printf "%s/config/database-port" .Values.ssm.prefix | quote }}
    - secretKey: DB_USER
      remoteRef:
        key: {{ printf "%s/config/database-username" .Values.ssm.prefix | quote }}
    - secretKey: DB_NAME
      remoteRef:
        key: {{ printf "%s/config/database-name" .Values.ssm.prefix | quote }}
    - secretKey: DB_PASSWORD
      remoteRef:
        key: {{ printf "%s/secrets/database-password" .Values.ssm.prefix | quote }}
    - secretKey: JWT_SECRET
      remoteRef:
        key: {{ printf "%s/secrets/jwt-secret" .Values.ssm.prefix | quote }}
    - secretKey: TOKEN_ENCRYPTION_KEY
      remoteRef:
        key: {{ printf "%s/secrets/token-encryption-key" .Values.ssm.prefix | quote }}
    - secretKey: AWS_REGION
      remoteRef:
        key: {{ printf "%s/config/aws-region" .Values.ssm.prefix | quote }}
    - secretKey: GREPTILE_API_URL
      remoteRef:
        key: {{ printf "%s/config/greptile-api-url" .Values.ssm.prefix | quote }}
    - secretKey: APP_URL
      remoteRef:
        key: {{ printf "%s/config/app-url" .Values.ssm.prefix | quote }}
    - secretKey: WEBHOOK_SECRET
      remoteRef:
        key: {{ printf "%s/secrets/webhook-secret" .Values.ssm.prefix | quote }}
    {{- if .Values.llmproxy.enabled }}
    - secretKey: LLM_PROXY_KEY
      remoteRef:
        key: {{ printf "%s/secrets/llm-proxy-key" .Values.ssm.prefix | quote }}
    {{- end }}
    - secretKey: ANALYTICS
      remoteRef:
        key: {{ printf "%s/config/analytics" .Values.ssm.prefix | quote }}
    - secretKey: NOTIFICATIONS
      remoteRef:
        key: {{ printf "%s/config/notifications" .Values.ssm.prefix | quote }}
    {{- range $key := .Values.ssm.extraConfigKeys }}
    - secretKey: {{ $key | replace "-" "_" | upper }}
      remoteRef:
        key: {{ printf "%s/config/%s" $.Values.ssm.prefix $key | quote }}
    {{- end }}
    {{- range $key := .Values.ssm.extraSecretKeys }}
    - secretKey: {{ $key | replace "-" "_" | upper }}
      remoteRef:
        key: {{ printf "%s/secrets/%s" $.Values.ssm.prefix $key | quote }}
    {{- end }}
