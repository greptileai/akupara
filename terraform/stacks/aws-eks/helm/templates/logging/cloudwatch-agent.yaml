{{/*
Purpose:
- Optional CloudWatch agent DaemonSet + config for shipping container logs to CloudWatch Logs.
- Terraform is expected to own the log group + retention; this chart configures collection + IRSA.
*/}}

{{- if .Values.cloudwatchLogs.enabled }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cloudwatch-agent-sa
  namespace: {{ .Release.Namespace }}
  {{- if .Values.irsa.cloudwatch }}
  annotations:
    eks.amazonaws.com/role-arn: {{ .Values.irsa.cloudwatch | quote }}
  {{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cloudwatch-agent-role
rules:
  - apiGroups: [""]
    resources: ["pods", "nodes", "endpoints"]
    verbs: ["list", "watch"]
  - apiGroups: [""]
    resources: ["nodes/proxy"]
    verbs: ["get"]
  - apiGroups: [""]
    resources: ["nodes/stats", "configmaps", "events"]
    verbs: ["create", "get"]
  - apiGroups: [""]
    resources: ["configmaps"]
    resourceNames: ["cwagent-clusterleader"]
    verbs: ["get", "update"]
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["list", "watch"]
  - apiGroups: ["apps"]
    resources: ["deployments", "daemonsets", "replicasets", "statefulsets"]
    verbs: ["list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cloudwatch-agent-role-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cloudwatch-agent-role
subjects:
  - kind: ServiceAccount
    name: cloudwatch-agent-sa
    namespace: {{ .Release.Namespace }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cloudwatch-agent-config
  namespace: {{ .Release.Namespace }}
data:
  cwagentconfig.json: |
    {
      "agent": {
        "region": "{{ .Values.global.region }}"
      },
      "logs": {
        "force_flush_interval": 5,
        "logs_collected": {
          "files": {
            "collect_list": [
              {
                "file_path": "/var/log/containers/api-*.log",
                "log_group_name": "{{ .Values.cloudwatchLogs.logGroupName }}",
                "log_stream_name": "api",
                "timezone": "UTC"
              },
              {
                "file_path": "/var/log/containers/auth-*.log",
                "log_group_name": "{{ .Values.cloudwatchLogs.logGroupName }}",
                "log_stream_name": "auth",
                "timezone": "UTC"
              },
              {
                "file_path": "/var/log/containers/web-*.log",
                "log_group_name": "{{ .Values.cloudwatchLogs.logGroupName }}",
                "log_stream_name": "web",
                "timezone": "UTC"
              },
              {
                "file_path": "/var/log/containers/indexer-*.log",
                "log_group_name": "{{ .Values.cloudwatchLogs.logGroupName }}",
                "log_stream_name": "indexer",
                "timezone": "UTC"
              },
              {
                "file_path": "/var/log/containers/greptile-db-migration-*.log",
                "log_group_name": "{{ .Values.cloudwatchLogs.logGroupName }}",
                "log_stream_name": "greptile-db-migration",
                "timezone": "UTC"
              },
              {
                "file_path": "/var/log/containers/llmproxy-*.log",
                "log_group_name": "{{ .Values.cloudwatchLogs.logGroupName }}",
                "log_stream_name": "llmproxy",
                "timezone": "UTC"
              },
              {
                "file_path": "/var/log/containers/jobs-*.log",
                "log_group_name": "{{ .Values.cloudwatchLogs.logGroupName }}",
                "log_stream_name": "jobs",
                "timezone": "UTC"
              },
              {
                "file_path": "/var/log/containers/reviews-*.log",
                "log_group_name": "{{ .Values.cloudwatchLogs.logGroupName }}",
                "log_stream_name": "reviews",
                "timezone": "UTC"
              }
            ]
          }
        }
      }
    }
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: cloudwatch-agent
  namespace: {{ .Release.Namespace }}
spec:
  selector:
    matchLabels:
      name: cloudwatch-agent
  template:
    metadata:
      labels:
        name: cloudwatch-agent
    spec:
      serviceAccountName: cloudwatch-agent-sa
      containers:
        - name: cloudwatch-agent
          image: public.ecr.aws/cloudwatch-agent/cloudwatch-agent:latest
          imagePullPolicy: Always
          env:
            - name: RUN_WITH_IRSA
              value: "True"
            - name: HOST_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.hostIP
            - name: HOST_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: K8S_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          volumeMounts:
            - name: cwagentconfig
              mountPath: /etc/cwagentconfig
            - name: containerlog
              mountPath: /var/log/containers
              readOnly: true
            - name: podlog
              mountPath: /var/log/pods
              readOnly: true
            - name: varlog
              mountPath: /var/log
              readOnly: true
      volumes:
        - name: cwagentconfig
          configMap:
            name: cloudwatch-agent-config
        - name: containerlog
          hostPath:
            path: /var/log/containers
        - name: podlog
          hostPath:
            path: /var/log/pods
        - name: varlog
          hostPath:
            path: /var/log
{{- end }}
